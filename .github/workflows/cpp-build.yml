# =================================================================================================
# GitHub Actions Workflow: PJSIP Build for Windows, Linux, and Linux ARM
#
# This workflow automates the compilation of the PJSIP project for Windows (x64), Linux (x64),
# and Linux ARM (64-bit). It is triggered on pushes to the 'main' branch and automatically
# creates a tag and release for each successful build on 'main'. It also continues to be
# triggered by manually pushed version tags. Build artifacts are named
# using the UTC date and time of the build.
#
# The main change is the integration of pre-compiled Opus libraries (assuming that
# they are provided by the same company 'sufficit' via GitHub Releases), instead of
# installing system development packages or compiling Opus internally.
#
# Action Version: 1.0.34
# Last Updated: 2025-06-17
# Description of Changes:
#   - FIXED: O script `download_opus_windows.ps1` foi modificado para remover o bloco 'param'
#     e ler o GitHubToken diretamente do ambiente ($env:GH_PAT). Isso resolveu o erro
#     "'param' not recognized".
#   - Fixed: Erro "Cannot find path" para config_site_content.h e pjsip_extra_defines_content.h.
#     A causa foi a ausência desses ficheiros no diretório 'scripts/'. A solução é que
#     estes ficheiros devem ser adicionados e committados ao repositório 'sufficit-microsip/scripts'.
#     Os conteúdos sugeridos para esses ficheiros foram fornecidos.
#   - TENTATIVA FALHADA: A exclusão de projetos problemáticos via `/p:ExcludeRestorePackageFolders=true`
#     no MSBuild falhou com o erro "MSB1006: Property is not valid". Esta propriedade não é
#     um parâmetro de linha de comando para exclusão direta de projetos por GUID.
#   - SOLUÇÃO ATUAL (PJSIP Build): Em vez de tentar excluir, agora compilamos APENAS os projetos PJSIP
#     conhecidamente necessários para o MicroSIP, listando-os explicitamente para o MSBuild.
#     Esta etapa foi bem-sucedida nos últimos logs.
#   - FIXED: Erro "Cannot bind argument to parameter 'PjsipLibRoot' because it is an empty string."
#     A causa foi a variável `$pjsipLibRoot` não ser passada corretamente para o `patch_microsip_vcxproj.ps1` na Step 5.
#     Agora, garantimos que todas as variáveis de caminho são passadas explicitamente como parâmetros
#     para o script de patch em ambas as etapas onde ele é usado.
#   - FIXED: Erro "A parameter cannot be found that matches parameter name 'PjsipIncludeRoot'."
#     A causa foi a chamada a `patch.ps1` em vez de `patch_microsip_vcxproj.ps1` na Step 4. Além disso,
#     as variáveis de caminho não estavam definidas no escopo do `run` block da Step 4 antes de serem usadas.
#     A chamada foi corrigida para usar o nome de ficheiro correto e as variáveis são agora definidas localmente.
#   - Configured the `Build PJSIP` step to use a Personal Access Token (PAT) for downloading
#     Opus artifacts, explicitly passing it to `download_opus_windows.ps1` to resolve
#     `401 Unauthorized` errors for cross-repository access.
#   - Added `contents: read` permission to the job to allow downloading Opus artifacts
#     from another repository, resolving the 401 Unauthorized error.
#   - Changed 'config_site.h' and 'pjsip_extra_defines.h' generation to direct file copying
#     from pre-existing files in 'scripts/' to resolve persistent C preprocessor errors.
#   - Ensured all comments in the code are in English.
#   - Implemented downloading of pre-compiled Opus artifacts from the 'sufficit/opus' repository
#     (via GitHub Releases) in each PJSIP build job, with enhanced logic for naming and extraction,
#     and improved error handling in `download_opus_windows.ps1`.
#   - Removed `libopus-dev` dependencies from package installers.
#   - Adjusted compilation flags (CFLAGS) as necessary.
#   - Updated the patch script for `microsip.vcxproj` to correctly include all necessary
#     paths for MicroSIP's internal headers, JSON, and PJSIP headers, resolving
#     'Cannot open include file' errors during MicroSIP compilation.
# =================================================================================================

name: Compilar MicroSIP no Windows (com Opus e PJSIP)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-microsip:
    name: Compilar MicroSIP no Windows
    runs-on: windows-latest
    permissions: # Adicione esta seção
      contents: read # Concede permissão de leitura para o GITHUB_TOKEN

    steps:
      # Step 1: Checkout do repositório MicroSIP
      - name: Checkout do Repositório MicroSIP
        uses: actions/checkout@v4
        with:
          repository: sufficit/sufficit-microsip
          path: . # Checkout para a raiz do workspace
          submodules: recursive

      # Step 2: Checkout do repositório PJSIP
      - name: Checkout do Repositório PJSIP
        uses: actions/checkout@v4
        with:
          repository: sufficit/pjproject
          path: external/pjproject # Clonar PJSIP para external/pjproject

      # Step 3: Configurar MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64 # Garantir que o MSBuild para x64 está disponível

      # Step 4: Compilar PJSIP
      - name: Build PJSIP
        shell: pwsh # Isso garante que o bloco 'run' é interpretado pelo pwsh
        env:
          GH_PAT: ${{ secrets.GH_PAT }} # Define GH_PAT a partir dos segredos do repositório
        run: |
          # Navegar para o diretório PJSIP
          Set-Location external/pjproject
          Write-Host "Caminho atual Set-Location: $(Get-Location)"

          # Depuração: Verificar a Versão do PowerShell em uso
          Write-Host "PowerShell Version being used:"
          $PSVersionTable | Format-List | Out-String | Write-Host

          # Descarregar e preparar bibliotecas Opus para PJSIP
          Write-Host "Executando scripts/download_opus_windows.ps1 para PJSIP (via ficheiro temporário)..."
          # O script download_opus_windows.ps1 está na raiz do repositório principal (sufficit-microsip)
          # Por isso, o caminho deve ser relativo ao GITHUB_WORKSPACE
          $scriptPath = "$env:GITHUB_WORKSPACE/scripts/download_opus_windows.ps1"
          $tempScriptPath = "temp_download_opus.ps1"

          # Histórico de tentativas para resolver o erro "param is not recognized" e "Unauthorized":
          #
          # 1. Chamada direta com & e aspas duplas (tentativa original):
          #    & "$env:GITHUB_WORKSPACE\scripts\download_opus_windows.ps1" -GitHubToken "$env:GH_PAT"
          #    Problema: O PowerShell interpretava a barra invertida como escape dentro da string,
          #              ou o 'param' não era reconhecido por não ser um bloco de script explícito.
          #              Isso resultava em "The term '\' is not recognized".
          #
          # 2. Envolver a chamada em um bloco `pwsh -Command` (tentativa):
          #    pwsh -Command "& \"$env:GITHUB_WORKSPACE/scripts/download_opus_windows.ps1\" -GitHubToken \"$env:GH_PAT\""
          #    Problema: Embora a sintaxe para 'param' fosse tecnicamente correta para um scriptblock,
          #              a interpolação de variáveis e aspas dentro da string ainda causavam problemas de análise.
          #              Ainda resultava em "The term 'param' is not recognized" e/ou "The term '\' is not recognized".
          #
          # 3. Usar 'pwsh -File' (tentativa mais recente e padrão):
          #    pwsh -File "$env:GITHUB_WORKSPACE/scripts/download_opus_windows.ps1" -GitHubToken "$env:GH_PAT"
          #    Problema: Apesar de ser a forma recomendada, o erro 'param' não reconhecido persistiu. Isso indicava
          #              que, mesmo com o '-File', a interpretação inicial do script falhava, possivelmente devido
          #              a um ambiente muito sensível ou a caracteres invisíveis.
          #
          # 4. Usar Dot-Sourcing (`. $scriptPath`):
          #    . $scriptPath -GitHubToken "$env:GH_PAT"
          #    Problema: Mesmo o dot-sourcing falhou com o erro 'param' não reconhecido, o que sugeria um
          #              problema mais fundamental com a análise do ficheiro em si pelo PowerShell. As verificações
          #              de depuração mostraram que o ficheiro era encontrado e parecia ter a codificação correta,
          #              mas o erro persistia.
          #
          # 5. Ler conteúdo do script e executar inline com `pwsh -Command "$scriptContent ..."`:
          #    $scriptContent = Get-Content $scriptPath -Raw -Encoding UTF8
          #    pwsh -Command "$scriptContent -GitHubToken '$env:GH_PAT'"
          #    Problema: Esta abordagem resultou no erro "The term 'param' is not recognized", o que é
          #              extremamente incomum, pois `pwsh -Command` deve interpretar o conteúdo da string
          #              diretamente como código PowerShell. Isso reforça a hipótese de um problema de
          #              caracteres invisíveis ou de codificação subtil no próprio ficheiro `download_opus_windows.ps1`
          #              que persiste mesmo após a leitura com -Encoding UTF8.
          #
          # Solução proposta que funcionou (V7 do download_opus_windows.ps1): O ficheiro `download_opus_windows.ps1`
          # foi modificado para remover o bloco `param` e ler o `$env:GH_PAT` diretamente. A execução
          # via ficheiro temporário com codificação controlada foi mantida para robustez.
          
          $scriptContent = Get-Content $scriptPath -Raw -Encoding UTF8 # Garante que a leitura é UTF8
          # Usa a classe .NET para criar uma codificação UTF8 sem BOM
          $utf8NoBomEncoding = New-Object System.Text.UTF8Encoding($false)
          Set-Content -Path $tempScriptPath -Value $scriptContent -Encoding $utf8NoBomEncoding

          # Agora, execute o ficheiro temporário
          # Este comando já não passa o token como parâmetro, pois o script lê de $env:GH_PAT
          pwsh -File $tempScriptPath
          if ($LASTEXITCODE -ne 0) { exit 1 }
          Write-Host "Scripts/download_opus_windows.ps1 concluído."

          # Copiar ficheiros de configuração PJSIP
          Write-Host "Copiando config_site.h e pjsip_extra_defines.h para PJSIP..."
          # Esses ficheiros devem existir em $env:GITHUB_WORKSPACE/scripts/
          # A sua ausência causou o erro "Cannot find path" em execuções anteriores.
          Copy-Item -Path "$env:GITHUB_WORKSPACE/scripts/config_site_content.h" -Destination "pjlib/include/pj/config_site.h" -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/scripts/pjsip_extra_defines_content.h" -Destination "pjlib/include/pj/pjsip_extra_defines.h" -Force
          Write-Host "Ficheiros de configuração PJSIP copiados."

          # Patch PJSIP pjmedia_codec.vcxproj para definições x64 e Opus
          Write-Host "Patching pjmedia_codec.vcxproj para PJSIP..."
          $pjmedia_codec_vcxproj_path = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "external/pjproject/pjmedia/build/pjmedia_codec.vcxproj"
          
          # Definir as variáveis de caminho localmente para este run block
          $pjsipIncludeRoot = "external/pjproject" # Relativo à raiz do MicroSIP
          $pjsipLibRoot = "external/pjproject/lib" # Relativo à raiz do MicroSIP
          $pjsipAppsIncludePath = "external/pjproject/pjsip/include" # Caminho relativo à raiz do MicroSIP

          # O script patch_microsip_vcxproj.ps1 está na raiz do repositório principal (sufficit-microsip)
          # Ele aceita PjsipIncludeRoot, PjsipLibRoot e PjsipAppsIncludePath como parâmetros.
          & "$env:GITHUB_WORKSPACE/scripts/patch_microsip_vcxproj.ps1" `
            -ProjFile $pjmedia_codec_vcxproj_path `
            -PjsipIncludeRoot $pjsipIncludeRoot ` # Passa a variável localmente definida
            -PjsipLibRoot $pjsipLibRoot `         # Passa a variável localmente definida
            -PjsipAppsIncludePath $pjsipAppsIncludePath # Passa a variável localmente definida
          if ($LASTEXITCODE -ne 0) { exit 1 }
          Write-Host "pjmedia_codec.vcxproj patched."

          # Compilar a solução PJSIP
          Write-Host "Compilando projetos PJSIP essenciais..."
          $pjsipProjectsToBuild = @(
              "pjlib/build/pjlib.vcxproj",
              "pjlib-util/build/pjlib_util.vcxproj",
              "pjnath/build/pjnath.vcxproj",
              "pjmedia/build/pjmedia.vcxproj",
              "pjmedia/build/pjmedia_audiodev.vcxproj",
              "pjmedia/build/pjmedia_codec.vcxproj",
              "pjmedia/build/pjmedia_videodev.vcxproj",
              "pjsip/build/pjsip_core.vcxproj",
              "pjsip/build/pjsip_simple.vcxproj",
              "pjsip/build/pjsip_ua.vcxproj",
              "pjsip/build/pjsua_lib.vcxproj",
              "pjsip/build/pjsua2_lib.vcxproj",
              "third_party/build/baseclasses/libbaseclasses.vcxproj",
              "third_party/build/g7221/libg7221codec.vcxproj",
              "third_party/build/gsm/libgsmcodec.vcxproj",
              "third_party/build/ilbc/libilbccodec.vcxproj",
              "third_party/build/milenage/libmilenage.vcxproj",
              "third_party/build/resample/libresample.vcxproj",
              "third_party/build/speex/libspeex.vcxproj",
              "third_party/build/srtp/libsrtp.vcxproj",
              "third_party/build/webrtc/libwebrtc.vcxproj",
              "third_party/build/yuv/libyuv.vcxproj"
          )

          # Compilar cada projeto PJSIP essencial individualmente
          foreach ($projectFile in $pjsipProjectsToBuild) {
              $fullProjectPath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "external/pjproject/$projectFile"
              Write-Host "Compilando projeto: $fullProjectPath"
              # Usamos /p:ExcludeRestorePackageFolders=true para evitar problemas de restauração de pacotes
              # .NET em projetos C++ (embora o problema principal sejam os .csproj)
              & msbuild.exe "$fullProjectPath" /p:Configuration=Release /p:Platform=x64 /m /t:Rebuild /p:ExcludeRestorePackageFolders=true
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "##[error]A compilação do projeto PJSIP $projectFile falhou."
                  exit 1
              }
          }
          Write-Host "Compilação PJSIP concluída."

          # Voltar para o diretório raiz do MicroSIP
          Set-Location $env:GITHUB_WORKSPACE
          Write-Host "Voltando ao diretório raiz do MicroSIP: $(Get-Location)"

      # Step 5: Aplicar patch ao ficheiro de projeto do MicroSIP
      - name: Aplicar patch ao projeto MicroSIP
        shell: pwsh
        run: |
          $microsipVcxprojPath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "microsip.vcxproj"
          # Definir as variáveis de caminho aqui para garantir que são válidas quando o script é chamado
          $pjsipIncludeRoot = "external/pjproject" # Relativo à raiz do MicroSIP (onde os módulos PJSIP estão)
          $pjsipLibRoot = "external/pjproject/lib" # Relativo à raiz do MicroSIP (onde as libs PJSIP serão geradas)
          $pjsipAppsIncludePath = "external/pjproject/pjsip/include" # Caminho para pjsua.h

          Write-Host "Aplicando patch ao microsip.vcxproj em: $microsipVcxprojPath"
          Write-Host "PJSIP Include Root: $pjsipIncludeRoot"
          Write-Host "PJSIP Lib Path: $pjsipLibRoot"
          Write-Host "PJSIP Apps Include Path: $pjsipAppsIncludePath"

          # Chamar o script de patch com todos os parâmetros necessários
          # O script patch_microsip_vcxproj.ps1 está na raiz do repositório principal (sufficit-microsip)
          & "$env:GITHUB_WORKSPACE/scripts/patch_microsip_vcxproj.ps1" `
            -ProjFile $microsipVcxprojPath `
            -PjsipIncludeRoot $pjsipIncludeRoot `
            -PjsipLibRoot $pjsipLibRoot `
            -PjsipAppsIncludePath $pjsipAppsIncludePath
          if ($LASTEXITCODE -ne 0) { exit 1 }

      # Step 6: Compilar a solução MicroSIP (final)
      - name: Compilar Solução MicroSIP (Final)
        shell: pwsh
        run: |
          $microsipSlnPath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "MicroSIP.sln"
          Write-Host "Compilando solução MicroSIP: $microsipSlnPath"
          msbuild.exe "$microsipSlnPath" /p:Configuration=Release /p:Platform=x64 /m /t:Build
          if ($LASTEXITCODE -ne 0) {
              Write-Host "##[error]A compilação do MicroSIP falhou com o código de saída $LASTEXITCODE."
              exit 1
          }
          Write-Host "Compilação do MicroSIP concluída com sucesso."

      # Step 7: Opcional: Upload de artefatos da compilação do MicroSIP
      - name: Upload de Binários do MicroSIP
        uses: actions/upload-artifact@v4
        with:
          name: microsip-windows-x64-binarios
          path: |
            MicroSIP\x64\Release\MicroSIP.exe
            MicroSIP\x64\Release\*.dll
            MicroSIP\x64\Release\*.lib
            # Adicione outros arquivos importantes se necessário, ex: pjsip.dll se for dynamic build
